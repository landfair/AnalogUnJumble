<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnJumble Worksheet Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Gotham', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #57068c;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: #57068c;
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .logo {
            height: 40px;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 300;
            letter-spacing: -0.5px;
        }
        
        .input-section {
            padding: 40px;
            background: #f8f8f8;
            position: relative;
        }
        
        .bank-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .bank-toggle-button {
            background: white;
            color: #57068c;
            border: 2px solid #57068c;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bank-toggle-button:hover {
            background: #57068c;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(87, 6, 140, 0.3);
        }
        
        .bank-icon {
            font-size: 1.2em;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 500;
            color: #212121;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
        }
        
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 0;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #57068c;
            box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.1);
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 30px;
            background: #57068c;
            color: white;
            border: none;
            border-radius: 0;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: #330452;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(87, 6, 140, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .secondary-button {
            background: #666;
        }
        
        .secondary-button:hover {
            background: #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .edit-section {
            padding: 30px;
            background: #fff;
            border: 2px solid #57068c;
            margin: 20px 0;
            display: none;
        }
        
        .edit-section.active {
            display: block;
        }
        
        .edit-header {
            font-size: 1.3em;
            font-weight: bold;
            color: #57068c;
            margin-bottom: 15px;
        }
        
        .edit-instructions {
            background: #f0e6ff;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #57068c;
            font-size: 0.95em;
        }
        
        .sentence-editor {
            margin-bottom: 20px;
        }
        
        .sentence-editor-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .sentence-editor-number {
            font-weight: bold;
            min-width: 30px;
            color: #57068c;
        }
        
        .sentence-editor-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            font-size: 1em;
            font-family: inherit;
        }
        
        .sentence-editor-input:focus {
            outline: none;
            border-color: #57068c;
            box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.1);
        }
        
        .remove-sentence-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .remove-sentence-btn:hover {
            background: #c82333;
        }
        
        .add-sentence-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .add-sentence-btn:hover {
            background: #218838;
        }
        
        .edit-buttons {
            display: flex;
            gap: 15px;
        }
        
        .finalize-btn {
            background: #57068c;
            color: white;
            padding: 12px 30px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .finalize-btn:hover {
            background: #330452;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(87, 6, 140, 0.3);
        }
        
        .cancel-edit-btn {
            background: #666;
            color: white;
            padding: 12px 30px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cancel-edit-btn:hover {
            background: #444;
        }
        
        .worksheet {
            padding: 40px 60px;
            background: white;
            display: none;
            font-family: 'Times New Roman', serif;
        }
        
        .worksheet.active {
            display: block;
        }
        
        .worksheet-header {
            margin-bottom: 20px;
            position: relative;
            padding-right: 150px;
        }
        
        .worksheet-logo {
            position: absolute;
            top: 0;
            right: 0;
            height: 40px;
        }
        
        .worksheet-title {
            display: none;
        }
        
        .worksheet-instructions {
            font-size: 0.95em;
            line-height: 1.4;
            text-align: left;
            color: #000;
            margin-bottom: 20px;
        }
        
        .sentence-item {
            display: flex;
            margin: 10px 0;
            border: 1px solid #000;
            background: white;
            page-break-inside: avoid;
            align-items: center;
        }
        
        .sentence-number {
            font-weight: bold;
            font-size: 1.4em;
            padding: 15px 20px;
            min-width: 60px;
            color: #000;
            text-align: center;
            border-right: 1px solid #000;
        }
        
        .sentence-text {
            flex: 1;
            font-size: 1em;
            line-height: 1.4;
            color: #000;
            padding: 15px 20px;
        }
        
        .submission-sheet {
            margin-top: 40px;
            padding: 30px;
            border: 2px solid #000;
            page-break-before: always;
        }
        
        .submission-title {
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .team-info {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #000;
        }
        
        .team-line {
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        .team-line span {
            display: inline-block;
            width: 150px;
        }
        
        .attempt-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #000;
        }
        
        .attempt-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .attempt-grid {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .number-box {
            width: 40px;
            height: 40px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feedback-line {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #666;
            font-size: 1em;
        }
        
        .feedback-line span {
            display: inline-block;
            width: auto;
        }
        
        .answer-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #57068c;
            background: #f9f7fc;
        }
        
        .answer-label {
            font-weight: bold;
            font-size: 1.2em;
            display: block;
            color: #57068c;
            margin-bottom: 10px;
        }
        
        .answer-text {
            font-size: 1.1em;
            color: #000;
            display: block;
        }
        
        /* Modal Styles */
        .puzzle-bank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        
        .puzzle-bank-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }
        
        .modal-content {
            position: relative;
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: #57068c;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #330452;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .modal-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .modal-header-buttons .secondary-button {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .export-button {
            background: #28a745;
        }
        
        .export-button:hover {
            background: #218838;
        }
        
        .import-button {
            background: #17a2b8;
        }
        
        .import-button:hover {
            background: #138496;
        }
        
        .import-input {
            display: none;
        }
        
        .close-button {
            background: transparent;
            color: white;
            border: none;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: none;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            background: #f8f8f8;
        }
        
        .empty-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: white;
            border: 1px solid #ddd;
        }
        
        .puzzle-card {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .puzzle-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
            border-left: 4px solid #57068c;
        }
        
        .puzzle-info {
            flex: 1;
        }
        
        .puzzle-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .puzzle-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .puzzle-preview {
            font-size: 0.85em;
            color: #888;
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 500px;
        }
        
        .puzzle-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .puzzle-actions button {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .delete-button {
            background: #dc3545;
        }
        
        .delete-button:hover {
            background: #c82333;
        }
        
        .load-button {
            background: #57068c;
        }
        
        .load-button:hover {
            background: #330452;
        }

        /* Worksheet Preview Modal Styles */
        .worksheet-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
        }

        .worksheet-preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .worksheet-modal-content {
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
        }

        .worksheet-preview-body {
            padding: 40px 60px;
            background: white;
            font-family: 'Times New Roman', serif;
            overflow-y: auto;
            max-height: 70vh;
        }

        /* Hide elements in modal preview that should only show when printing */
        .worksheet-preview-body .hide-for-print {
            display: none !important;
        }

        /* Student version cut-line sentence items */
        .sentence-item-cut {
            display: flex;
            margin: 10px 0;
            border-top: 2px dashed #999;
            border-bottom: 2px dashed #999;
            border-left: 2px dashed #999;
            border-right: 2px dashed #999;
            background: white;
            align-items: center;
            position: relative;
        }

        .sentence-item-cut::before {
    content: "✂";
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%) rotate(90deg);
    background: white;
    padding: 2px;
    font-size: 12px;
    color: #666;
}

.sentence-item-cut::after {
    content: "✂";
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%) rotate(-90deg);
    background: white;
    padding: 2px;
    font-size: 12px;
    color: #666;
}

        .sentence-number-cut {
            font-weight: bold;
            font-size: 1.4em;
            padding: 15px 20px;
            min-width: 60px;
            color: #000;
            text-align: center;
            border-right: 1px solid #000;
        }

        .sentence-text-cut {
            flex: 1;
            font-size: 1em;
            line-height: 1.4;
            color: #000;
            padding: 15px 20px;
        }

        @media print {
            .worksheet-preview-modal {
                display: none !important;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .input-section {
                display: none;
            }
            
            .puzzle-bank-modal {
                display: none !important;
            }
            
            .header {
                display: none;
            }
            
            .worksheet {
                padding: 30px 40px;
                font-size: 12pt;
            }
            
            .sentence-item {
                border: 1px solid #000;
                margin: 8px 0;
            }
            
            .sentence-number {
                border-right: 1px solid #000;
            }
            
            .worksheet-title {
                font-size: 16pt;
            }
            
            .worksheet-instructions {
                font-size: 11pt;
            }
            
            .hide-for-print {
                display: none !important;
            }
            
            .show-for-print {
                display: block !important;
            }
        }

                /* Add to existing CSS for modal preview */
        .worksheet-preview-body .worksheet-header {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .worksheet-preview-body .logo-container {
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }

        .worksheet-preview-body .worksheet-logo {
            height: 40px;
        }

        .worksheet-preview-body .instructions-container {
            width: 100%;
            border: 1px solid #ccc;
            padding: 15px;
            background: #f9f9f9;
        }

        .worksheet-preview-body .worksheet-instructions {
            font-size: 0.95em;
            line-height: 1.4;
            text-align: left;
            color: #000;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://i.imgur.com/iIODsNl.png" alt="NYU Logo" class="logo">
            <h1>UnJumble Worksheet Generator</h1>
        </div>
        
        <div class="input-section">
            <div class="bank-toggle-container">
                <button class="bank-toggle-button" onclick="togglePuzzleBank()">
                    <span class="bank-icon">📚</span>
                    Puzzle Bank (<span id="puzzleCount">0</span>)
                </button>
            </div>
            
            <div class="input-group">
                <label for="title">Worksheet Title:</label>
                <input type="text" id="title" placeholder="e.g., Transfer of Learning" value="UnJumble">
            </div>
            
            <div class="input-group">
                <label for="instructions">Instructions (optional):</label>
                <textarea id="instructions" placeholder="Enter custom instructions for your worksheet...">Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.</textarea>
            </div>
            
            <div class="input-group">
                <label for="sourceText">Source Attribution (optional):</label>
                <input type="text" id="sourceText" placeholder="e.g., from David Perkin's 'Transfer of Learning'">
            </div>
            
            <div class="input-group">
                <label for="paragraph">Paste your paragraph:</label>
                <textarea id="paragraph" placeholder="Paste the paragraph you want to turn into an UnJumble puzzle game..."></textarea>
            </div>
            
            <div class="button-group">
                <button onclick="generateWorksheet()">Generate Worksheet</button>
                <button class="secondary-button" onclick="saveToBank()">Save to Bank</button>
                <button class="secondary-button" onclick="printStudentVersion()">Print Student Version</button>
                <button class="secondary-button" onclick="printInstructorVersion()">Print Instructor Copy</button>
                <button class="secondary-button" onclick="resetForm()">Reset</button>
            </div>
            
            <div class="preview-notice" id="previewNotice">
                ✓ Worksheet generated! Use the print buttons above to print different versions.
            </div>
            
            <div class="edit-section" id="editSection">
                <div class="edit-header">Edit Sentences</div>
                <div class="edit-instructions">
                    Review and edit the sentences below. You can modify text, add new sentences, or remove unwanted ones. 
                    This is helpful if the automatic sentence splitting didn't work correctly.
                </div>
                <div class="sentence-editor" id="sentenceEditor">
                    <!-- Sentence inputs will be generated here -->
                </div>
                <button class="add-sentence-btn" onclick="addSentence()">+ Add Sentence</button>
                <div class="edit-buttons">
                    <button class="finalize-btn" onclick="finalizeWorksheet()">Finalize Worksheet</button>
                    <button class="cancel-edit-btn" onclick="cancelEdit()">Cancel</button>
                </div>
            </div>
        </div>
        
        <div class="worksheet" id="worksheet">
            <!-- Worksheet content will be generated here -->
        </div>
    </div>
    
    <!-- Puzzle Bank Modal -->
    <div class="puzzle-bank-modal" id="puzzleBankModal">
        <div class="modal-overlay" onclick="closePuzzleBank()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Puzzle Bank</h2>
                <div class="modal-header-buttons">
                    <button class="secondary-button export-button" onclick="exportPuzzles()">Export All</button>
                    <button class="secondary-button import-button" onclick="document.getElementById('importInput').click()">Import</button>
                    <input type="file" id="importInput" class="import-input" accept=".json" onchange="importPuzzles(event)">
                    <button class="secondary-button" onclick="clearAllPuzzles()">Clear All</button>
                    <button class="close-button" onclick="closePuzzleBank()">×</button>
                </div>
            </div>
            <div class="modal-body" id="bankContent">
                <p class="empty-message">No saved puzzles yet. Generate a worksheet and click "Save to Bank" to store it.</p>
            </div>
        </div>
    </div>

    <!-- Worksheet Preview Modal -->
        <div class="worksheet-preview-modal" id="worksheetPreviewModal">
            <div class="modal-overlay" onclick="closeWorksheetPreview()"></div>
            <div class="modal-content worksheet-modal-content">
                <div class="modal-header">
                    <h2>Worksheet Preview</h2>
                    <div class="modal-header-buttons">
                        <button class="secondary-button" onclick="printStudentVersion()">Print Student Version</button>
                        <button class="secondary-button" onclick="printInstructorVersion()">Print Instructor Copy</button>
                        <button class="secondary-button" onclick="saveToBank()">Save to Bank</button>
                        <button class="close-button" onclick="closeWorksheetPreview()">×</button>
                    </div>
                </div>
                <div class="modal-body worksheet-preview-body" id="worksheetPreviewContent">
                    <!-- Worksheet content will be inserted here -->
                </div>
            </div>
        </div>
    
    <script>
        let currentWorksheetData = null;
        let puzzleBank = [];
        let editingSentences = [];
        
        // Load saved puzzles from memory on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load from localStorage if available (won't work in Claude, but will work when deployed)
            try {
                const saved = localStorage.getItem('unjumblePuzzles');
                if (saved) {
                    puzzleBank = JSON.parse(saved);
                } else {
                    initializeDefaultPuzzles();
                }
            } catch (e) {
                // localStorage not available (Claude environment), use default puzzles
                initializeDefaultPuzzles();
            }
            updateBankDisplay();
            updatePuzzleCount();
            savePuzzleBank();  // Save after deleting
        });
        
        function initializeDefaultPuzzles() {
            // Pre-loaded puzzles organized by difficulty
            const defaultPuzzles = [
                // EASY PUZZLES
                {
                    title: "Future Shock (Easy)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from Alvin Toffler's 'Future Shock' (1970)",
                    sentences: [
                        "If the last 50,000 years of man's existence were divided into lifetimes of approximately sixty-two years each, there have been about 800 such lifetimes.",
                        "Of these 800, fully 650 were spent in caves.",
                        "Only during the last seventy lifetimes has it been possible to communicate effectively from one lifetime to another, as writing made it possible to do.",
                        "Only during the last six lifetimes did masses of men ever see a printed word.",
                        "Only during the last four has it been possible to measure time with any precision.",
                        "Only in the last two has anyone anywhere used an electric motor.",
                        "And the overwhelming majority of all the material goods we use in daily life today have been developed within the present, the 800th, lifetime.",
                        "This 800th lifetime marks a sharp break with all past human experience because during this lifetime man's relationship to resources has reversed itself."
                    ],
                    originalParagraph: "If the last 50,000 years of man's existence were divided into lifetimes of approximately sixty-two years each, there have been about 800 such lifetimes. Of these 800, fully 650 were spent in caves. Only during the last seventy lifetimes has it been possible to communicate effectively from one lifetime to another, as writing made it possible to do. Only during the last six lifetimes did masses of men ever see a printed word. Only during the last four has it been possible to measure time with any precision. Only in the last two has anyone anywhere used an electric motor. And the overwhelming majority of all the material goods we use in daily life today have been developed within the present, the 800th, lifetime. This 800th lifetime marks a sharp break with all past human experience because during this lifetime man's relationship to resources has reversed itself.",
                    savedAt: Date.now() - 3500000
                },

                {
                    title: "Technology Assessment Challenge (Easy)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from The Technology Assessment Act of 1972",
                    sentences: [
                        "As technology continues to change and expand rapidly, its applications are large and growing in scale; and increasingly extensive, pervasive, and critical in their impact— beneficial and adverse—on the natural and social environment.",
                        "Therefore, it is essential that, to the fullest extent possible, the consequences of technological applications be anticipated, understood, and considered in determination of public policy on existing and emerging national problems.",
                        "The Congress further finds that the Federal agencies presently responsible directly to the Congress are not designed to provide the legislative branch with adequate and timely information, independently developed, relating to the potential impact of technological applications, and the present mechanisms of the Congress do not and are not designed to provide the legislative branch with such information.",
                        "Accordingly, it is necessary for the Congress to equip itself with new and effective means for securing competent, unbiased information concerning the physical, biological, economic, social, and political effects of such applications; and utilize this information, whenever appropriate, as one factor in the legislative assessment of matters pending before the Congress, particularly in those instances where the Federal Government may be called upon to consider support for, or management or regulation of, technological applications."
                    ],
                    originalParagraph: "As technology continues to change and expand rapidly, its applications are large and growing in scale; and increasingly extensive, pervasive, and critical in their impact— beneficial and adverse—on the natural and social environment. Therefore, it is essential that, to the fullest extent possible, the consequences of technological applications be anticipated, understood, and considered in determination of public policy on existing and emerging national problems. The Congress further finds that the Federal agencies presently responsible directly to the Congress are not designed to provide the legislative branch with adequate and timely information, independently developed, relating to the potential impact of technological applications, and the present mechanisms of the Congress do not and are not designed to provide the legislative branch with such information. Accordingly, it is necessary for the Congress to equip itself with new and effective means for securing competent, unbiased information concerning the physical, biological, economic, social, and political effects of such applications; and utilize this information, whenever appropriate, as one factor in the legislative assessment of matters pending before the Congress, particularly in those instances where the Federal Government may be called upon to consider support for, or management or regulation of, technological applications.",
                    savedAt: Date.now() - 500000
                },
                
                {
                title: "Economics and Ethics (Easy)",
                instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                sourceText: "from Iain King's 'Can Economics Be Ethical?'",
                sentences: [
                    "There are different views on where ethics should apply when someone makes an economic decision.",
                    "Consider Adam Smith, widely regarded as the founder of modern economics.",
                    "He was a moral philosopher who believed sympathy for others was the basis for ethics (we would call it empathy nowadays).",
                    "But one of his key insights in The Wealth of Nations was that acting on this empathy could be counter-productive—he observed people becoming better off when they put their own empathy aside, and interacted in a self-interested way.",
                    "Smith justifies selfish behavior by the outcome.",
                    "Whenever planners use cost-benefit analysis to justify a new railway line, or someone retrains to boost his or her earning power, or a shopper buys one to get one free, they are using the same approach: empathizing with someone, and seeking an outcome that makes that person as well off as possible—although the person they are empathizing with may be themselves in the future."
                ],
                originalParagraph: "There are different views on where ethics should apply when someone makes an economic decision. Consider Adam Smith, widely regarded as the founder of modern economics. He was a moral philosopher who believed sympathy for others was the basis for ethics (we would call it empathy nowadays). But one of his key insights in The Wealth of Nations was that acting on this empathy could be counter-productive—he observed people becoming better off when they put their own empathy aside, and interacted in a self-interested way. Smith justifies selfish behavior by the outcome. Whenever planners use cost-benefit analysis to justify a new railway line, or someone retrains to boost his or her earning power, or a shopper buys one to get one free, they are using the same approach: empathizing with someone, and seeking an outcome that makes that person as well off as possible—although the person they are empathizing with may be themselves in the future.",
                savedAt: Date.now() - 4000000
            },
                
                // MEDIUM PUZZLES

                {
                    title: "Cognitive Load Theory (Medium)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from John Sweller's 'Cognitive Load Theory and Educational Technology'",
                    sentences: [
                        "The success or otherwise of educational technology is affected by the characteristics of human cognitive architecture.",
                        "Technology-based instruction used without reference to the instructional design principles that flow from human cognition is likely to be random in its effectiveness.",
                        "Cognitive load theory (Sweller et al. 2011, 2019), as an instructional design theory based on our rapidly expanding knowledge of human cognition, is well-suited to provide guidance suggesting which educational technologies are likely to be effective and how they should be used.",
                        "This paper summarises the theory and applies it to learning that occurs with the assistance of educational technology."
                    ],
                    originalParagraph: "The success or otherwise of educational technology is affected by the characteristics of human cognitive architecture. Technology-based instruction used without reference to the instructional design principles that flow from human cognition is likely to be random in its effectiveness. Cognitive load theory (Sweller et al. 2011, 2019), as an instructional design theory based on our rapidly expanding knowledge of human cognition, is well-suited to provide guidance suggesting which educational technologies are likely to be effective and how they should be used. This paper summarises the theory and applies it to learning that occurs with the assistance of educational technology.",
                    savedAt: Date.now() - 8000000
                },

                {
                    title: "Internet's Cognitive Effects (Medium)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from Nicholas Carr's 'The Web Shatters Focus, Rewires Brains'",
                    sentences: [
                        "The mental consequences of our online info-crunching are not universally bad.",
                        "Certain cognitive skills are strengthened by our use of computers and the Net.",
                        "These tend to involve more primitive mental functions, such as hand-eye coordination, reflex response, and the processing of visual cues.",
                        "One much-cited study of video gaming revealed that after just 10 days of playing action games on computers, a group of young people had significantly boosted the speed with which they could shift their visual focus between various images and tasks.",
                        "It's likely that Web browsing also strengthens brain functions related to fast-paced problem solving, particularly when it requires spotting patterns in a welter of data.",
                        "A British study of the way women search for medical information online indicated that an experienced Internet user can, at least in some cases, assess the trustworthiness and probable value of a Web page in a matter of seconds.",
                        "The more we practice surfing and scanning, the more adept our brain becomes at those tasks.",
                        "But it would be a serious mistake to look narrowly at such benefits and conclude that the Web is making us smarter."
                    ],
                    originalParagraph:  "The mental consequences of our online info-crunching are not universally bad. Certain cognitive skills are strengthened by our use of computers and the Net. These tend to involve more primitive mental functions, such as hand-eye coordination, reflex response, and the processing of visual cues. One much-cited study of video gaming revealed that after just 10 days of playing action games on computers, a group of young people had significantly boosted the speed with which they could shift their visual focus between various images and tasks. It's likely that Web browsing also strengthens brain functions related to fast-paced problem solving, particularly when it requires spotting patterns in a welter of data. A British study of the way women search for medical information online indicated that an experienced Internet user can, at least in some cases, assess the trustworthiness and probable value of a Web page in a matter of seconds. The more we practice surfing and scanning, the more adept our brain becomes at those tasks. But it would be a serious mistake to look narrowly at such benefits and conclude that the Web is making us smarter.",
                    
                    savedAt: Date.now() - 3000000
                },
                {
                    title: "Genetic Engineering and Pharming (Medium)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from Emily Anthes' 'Frankenstein's Cat'",
                    sentences: [
                        "When scientists first learned how to edit the genomes of animals, they began to imagine all the ways they could use this new power.",
                        "Creating brightly colored novelty pets was not a high priority.",
                        "Instead, most researchers envisioned far more consequential applications, hoping to create genetically engineered animals that saved human lives.",
                        "One enterprise is now delivering on this dream.",
                        "Welcome to the world of \"pharming,\" in which simple genetic tweaks turn animals into living pharmaceutical factories."
                    ],
                    originalParagraph: "When scientists first learned how to edit the genomes of animals, they began to imagine all the ways they could use this new power. Creating brightly colored novelty pets was not a high priority. Instead, most researchers envisioned far more consequential applications, hoping to create genetically engineered animals that saved human lives. One enterprise is now delivering on this dream. Welcome to the world of \"pharming,\" in which simple genetic tweaks turn animals into living pharmaceutical factories.",
                    savedAt: Date.now() - 1500000
                },
                {
                    title: "Writer-Based Prose (Medium)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from Linda Flower's 'Writer-Based Prose: A Cognitive Basis for Problems in Writing' (College English, 1979)",
                    sentences: [
                        "If writing is simply the act of \"expressing what you think\" or \"saying what you mean,\" why is writing often such a difficult thing to do?",
                        "And why do papers that do express what the writer meant (to his or her own satisfaction) often fail to communicate the same meaning to a reader?",
                        "Although we often equate writing with the straightforward act of \"saying what we mean,\" the mental struggles writers go through and the misinterpretations readers still make suggest that we need a better model of this process.",
                        "Modern communication theory and practical experience agree; writing prose that actually communicates what we mean to another person demands more than a simple act of self-expression.",
                        "What communication theory does not tell us is how writers do it.",
                        "An alternative to the \"think it/say it\" model is to say that effective writers do not simply express thought but transform it in certain complex but describable ways for the needs of a reader.",
                        "Conversely, we may find that ineffective writers are indeed merely \"expressing\" themselves by offering up an unretouched and underprocessed version of their own thought."
                    ],
                    originalParagraph: "If writing is simply the act of \"expressing what you think\" or \"saying what you mean,\" why is writing often such a difficult thing to do? And why do papers that do express what the writer meant (to his or her own satisfaction) often fail to communicate the same meaning to a reader? Although we often equate writing with the straightforward act of \"saying what we mean,\" the mental struggles writers go through and the misinterpretations readers still make suggest that we need a better model of this process. Modern communication theory and practical experience agree; writing prose that actually communicates what we mean to another person demands more than a simple act of self-expression. What communication theory does not tell us is how writers do it. An alternative to the \"think it/say it\" model is to say that effective writers do not simply express thought but transform it in certain complex but describable ways for the needs of a reader. Conversely, we may find that ineffective writers are indeed merely \"expressing\" themselves by offering up an unretouched and underprocessed version of their own thought.",
                    savedAt: Date.now() - 800000
                },
                
                // HARD PUZZLES
                {
                    title: "Chess Master's Dilemma (Hard)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from David Perkin's 'Transfer of Learning'",
                    sentences: [
                        "Once upon a time, an astute and beneficent leader in a remote country anticipated increasing aggression from a territory hungry neighbor.",
                        "Recognizing that the neighbor had more military might, the leader concluded that his people would have to outthink, rather than outpower, the enemy.",
                        "Undistinguished in its military armament and leadership, the country did have one remarkable resource: the reigning world chess master, undefeated for over twenty years.",
                        "\"Aha,\" the leader said to himself, \"we will recruit this intellect, honed so long on the whetstone of chess, teach him some politics and military theory, and then outmaneuver the enemy with the help of his genius.\"",
                        "A fanciful tale, to be sure, but consider the leaders plan for a moment: Is it disastrously naive, possibly helpful, or a good bet?",
                        "In fact, the tale has no definite conclusion.",
                        "Rather, it is the beginning of another tale, a tale about psychology and the human intellect that research is gradually spinning.",
                        "Questions like that of the chess master's neuropolitical and military potential stand in the center of one of the most puzzling and important issues that cognitive psychology has addressed: the roles of general and of context-specific knowledge in thinking."
                    ],
                    originalParagraph: "Once upon a time, an astute and beneficent leader in a remote country anticipated increasing aggression from a territory hungry neighbor. Recognizing that the neighbor had more military might, the leader concluded that his people would have to outthink, rather than outpower, the enemy. Undistinguished in its military armament and leadership, the country did have one remarkable resource: the reigning world chess master, undefeated for over twenty years. \"Aha,\" the leader said to himself, \"we will recruit this intellect, honed so long on the whetstone of chess, teach him some politics and military theory, and then outmaneuver the enemy with the help of his genius.\" A fanciful tale, to be sure, but consider the leaders plan for a moment: Is it disastrously naive, possibly helpful, or a good bet? In fact, the tale has no definite conclusion. Rather, it is the beginning of another tale, a tale about psychology and the human intellect that research is gradually spinning. Questions like that of the chess master's neuropolitical and military potential stand in the center of one of the most puzzling and important issues that cognitive psychology has addressed: the roles of general and of context-specific knowledge in thinking.",
                    savedAt: Date.now() - 5000000
                },
                {
                    title: "Fracking Our Attention (Hard)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from 'Powerful Forces Are Fracking Our Attention. We Can Fight Back.' by D. Graham Burnett, Alyssa Loh and Peter Schmidt, 2023",
                    sentences: [
                        "The lament is as old as education itself: The students aren't paying attention.",
                        "But today, the problem of flighty or fragmented attention has reached truly catastrophic proportions.",
                        "High school and college teachers overwhelmingly report that students' capacity for sustained, or deep attention has sharply decreased significantly impeding the forms of study — reading, looking at art, round-table discussions — once deemed central to the liberal arts.",
                        "By some measures you are lucky these days to get 47 seconds of focused attention on a discrete task.",
                        "\"Middlemarch\" is tough sledding on that timeline.",
                        "So are most forms of human interaction out of which meaningful life, collective action and political engagement are made.",
                        "We are witnessing the dark side of our new technological lives, whose extractive profit models amount to the systematic fracking of human beings: pumping vast quantities of high-pressure media content into our faces to force up a spume of the vaporous and intimate stuff called attention, which now trades on the open market.",
                        "Increasingly powerful systems seek to ensure that our attention is never truly ours."
                    ],
                    originalParagraph: "The lament is as old as education itself: The students aren't paying attention. But today, the problem of flighty or fragmented attention has reached truly catastrophic proportions. High school and college teachers overwhelmingly report that students' capacity for sustained, or deep attention has sharply decreased significantly impeding the forms of study — reading, looking at art, round-table discussions — once deemed central to the liberal arts. By some measures you are lucky these days to get 47 seconds of focused attention on a discrete task. \"Middlemarch\" is tough sledding on that timeline. So are most forms of human interaction out of which meaningful life, collective action and political engagement are made. We are witnessing the dark side of our new technological lives, whose extractive profit models amount to the systematic fracking of human beings: pumping vast quantities of high-pressure media content into our faces to force up a spume of the vaporous and intimate stuff called attention, which now trades on the open market. Increasingly powerful systems seek to ensure that our attention is never truly ours.",
                    savedAt: Date.now() - 2000000
                },
                {
                    title: "Organic Agriculture Paradox (Hard)",
                    instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                    sourceText: "from Bryan Walsh's 'Whole Food Blues: Why Organic Agriculture May Not Be So Sustainable'",
                    sentences: [
                        "In an increasingly hot and crowded world, the only sustainable way to live is to get more out of less.",
                        "Every environmentalist would agree.",
                        "But change the conversation to food, and suddenly efficiency doesn't look so good.",
                        "Conventional industrial agriculture has become incredibly efficient on a simple land to food basis.",
                        "Thanks to fertilizers, mechanization and irrigation, each American farmer feeds over 155 people worldwide.",
                        "Conventional farming gets more and more crop per square foot of cultivated land—over 170 bushels of corn per acre in Iowa, for example—which can mean less territory needs to be converted from wilderness to farmland.",
                        "And since a third of the planet is already used for agriculture—destroying forests and other wild habitats along the way—anything that could help us produce more food on less land would seem to be good for the environment.",
                        "Of course, that's not how most environmentalists regard their arugula."
                    ],
                    originalParagraph: "In an increasingly hot and crowded world, the only sustainable way to live is to get more out of less. Every environmentalist would agree. But change the conversation to food, and suddenly efficiency doesn't look so good. Conventional industrial agriculture has become incredibly efficient on a simple land to food basis. Thanks to fertilizers, mechanization and irrigation, each American farmer feeds over 155 people worldwide. Conventional farming gets more and more crop per square foot of cultivated land—over 170 bushels of corn per acre in Iowa, for example—which can mean less territory needs to be converted from wilderness to farmland. And since a third of the planet is already used for agriculture—destroying forests and other wild habitats along the way—anything that could help us produce more food on less land would seem to be good for the environment. Of course, that's not how most environmentalists regard their arugula.",
                    savedAt: Date.now() - 1000000
                },
                {
                title: "Television's Influence on Children (Hard)",
                instructions: "Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.",
                sourceText: "from Newton N. Minow's 1961 speech 'Television and the Public Interest'",
                sentences: [
                    "Certainly, I hope you will agree that ratings should have little influence where children are concerned.",
                    "The best estimates indicate that during the hours of five to six, sixty per cent of your audience is composed of children under twelve.",
                    "And most young children today, believe it or not, spend as much time watching television as they do in the schoolroom.",
                    "I repeat—let that sink in, ladies and gentlemen—most young children today spend as much time watching television as they do in the schoolroom.",
                    "It used to be said that there were three great influences on a child: home, school, and church.",
                    "Today, there is a fourth great influence, and you ladies and gentlemen in this room control it.",
                    "If parents, teachers, and ministers conducted their responsibilities by following the ratings, children would have  a steady diet of ice cream, school holidays, and no Sunday school.",
                    "What about your responsibilities?",
                    "Is there no room on television to teach, to inform, to uplift, to stretch, to enlarge the capacities of our children?"
                ],
                originalParagraph: "Certainly, I hope you will agree that ratings should have little influence where children are concerned. The best estimates indicate that during the hours of five to six, sixty per cent of your audience is composed of children under twelve. And most young children today, believe it or not, spend as much time watching television as they do in the schoolroom. I repeat—let that sink in, ladies and gentlemen—most young children today spend as much time watching television as they do in the schoolroom. It used to be said that there were three great influences on a child: home, school, and church. Today, there is a fourth great influence, and you ladies and gentlemen in this room control it. If parents, teachers, and ministers conducted their responsibilities by following the ratings, children would have  a steady diet of ice cream, school holidays, and no Sunday school. What about your responsibilities? Is there no room on television to teach, to inform, to uplift, to stretch, to enlarge the capacities of our children?",
                savedAt: Date.now() - 7000000
                },
            ];

            
            
            // Initialize the puzzle bank with default puzzles
            puzzleBank = defaultPuzzles;
        }
        
        function togglePuzzleBank() {
            const modal = document.getElementById('puzzleBankModal');
            modal.classList.toggle('active');
        }
        
        function closePuzzleBank() {
            const modal = document.getElementById('puzzleBankModal');
            modal.classList.remove('active');
        }
        
        function updatePuzzleCount() {
            const countElement = document.getElementById('puzzleCount');
            if (countElement) {
                countElement.textContent = puzzleBank.length;
            }
        }
        
        function updateBankDisplay() {
            const bankContent = document.getElementById('bankContent');
            
            if (puzzleBank.length === 0) {
                bankContent.innerHTML = '<p class="empty-message">No saved puzzles yet. Generate a worksheet and click "Save to Bank" to store it.</p>';
            } else {
                // Group puzzles by difficulty
                const easyPuzzles = puzzleBank.filter(p => p.title.includes('(Easy)'));
                const mediumPuzzles = puzzleBank.filter(p => p.title.includes('(Medium)'));
                const hardPuzzles = puzzleBank.filter(p => p.title.includes('(Hard)'));
                const otherPuzzles = puzzleBank.filter(p => !p.title.includes('(Easy)') && !p.title.includes('(Medium)') && !p.title.includes('(Hard)'));
                
                let html = '';
                
                if (easyPuzzles.length > 0) {
                    html += '<h3 style="color: #57068c; margin: 20px 0 10px 0;">EASY PUZZLES</h3>';
                    html += easyPuzzles.map((puzzle, index) => createPuzzleCard(puzzle, puzzleBank.indexOf(puzzle))).join('');
                }
                
                if (mediumPuzzles.length > 0) {
                    html += '<h3 style="color: #57068c; margin: 20px 0 10px 0;">MEDIUM PUZZLES</h3>';
                    html += mediumPuzzles.map((puzzle, index) => createPuzzleCard(puzzle, puzzleBank.indexOf(puzzle))).join('');
                }
                
                if (hardPuzzles.length > 0) {
                    html += '<h3 style="color: #57068c; margin: 20px 0 10px 0;">HARD PUZZLES</h3>';
                    html += hardPuzzles.map((puzzle, index) => createPuzzleCard(puzzle, puzzleBank.indexOf(puzzle))).join('');
                }
                
                if (otherPuzzles.length > 0) {
                    html += '<h3 style="color: #57068c; margin: 20px 0 10px 0;">OTHER PUZZLES</h3>';
                    html += otherPuzzles.map((puzzle, index) => createPuzzleCard(puzzle, puzzleBank.indexOf(puzzle))).join('');
                }
                
                bankContent.innerHTML = html;
            }
        }
        
        function createPuzzleCard(puzzle, index) {
            return `
                <div class="puzzle-card">
                    <div class="puzzle-info">
                        <div class="puzzle-title">${puzzle.title}</div>
                        <div class="puzzle-meta">${puzzle.sentences.length} sentences • Saved ${new Date(puzzle.savedAt).toLocaleDateString()}</div>
                        <div class="puzzle-preview">${puzzle.sentences[0].substring(0, 100)}...</div>
                    </div>
                    <div class="puzzle-actions">
                        <button class="load-button" onclick="loadPuzzle(${index})">Load</button>
                        <button class="delete-button" onclick="deletePuzzle(${index})">Delete</button>
                    </div>
                </div>
            `;
        }
        
        function saveToBank() {
            if (!currentWorksheetData) {
                alert('Please generate a worksheet first before saving.');
                return;
            }
            
            const puzzleData = {
                title: currentWorksheetData.title,
                instructions: currentWorksheetData.instructions,
                sourceText: currentWorksheetData.sourceText,
                sentences: currentWorksheetData.sentences,
                originalParagraph: currentWorksheetData.sentences.join(' '),
                savedAt: Date.now()
            };
            
            // Check if puzzle with same title exists
            const existingIndex = puzzleBank.findIndex(p => p.title === puzzleData.title);
            
            if (existingIndex !== -1) {
                if (confirm(`A puzzle titled "${puzzleData.title}" already exists. Do you want to overwrite it?`)) {
                    puzzleBank[existingIndex] = puzzleData;
                } else {
                    return;
                }
            } else {
                puzzleBank.push(puzzleData);
            }
            
            // Save to localStorage immediately
            try {
                localStorage.setItem('unjumblePuzzles', JSON.stringify(puzzleBank));
                console.log('Saved ' + puzzleBank.length + ' puzzles to localStorage');
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
            
            updateBankDisplay();
            updatePuzzleCount();
            alert(`Puzzle "${puzzleData.title}" has been saved to your bank!`);
        }
        
        function loadPuzzle(index) {
            const puzzle = puzzleBank[index];
            if (!puzzle) return;
            
            // Fill in the form fields
            document.getElementById('title').value = puzzle.title;
            document.getElementById('instructions').value = puzzle.instructions;
            document.getElementById('sourceText').value = puzzle.sourceText || '';
            document.getElementById('paragraph').value = puzzle.originalParagraph;
            
            // Close the modal
            closePuzzleBank();
            
            // Show edit section with the loaded sentences
            editingSentences = [...puzzle.sentences];
            showEditSection(puzzle.title, puzzle.instructions, puzzle.sourceText);
        }
        
        function deletePuzzle(index) {
            const puzzle = puzzleBank[index];
            if (confirm(`Are you sure you want to delete "${puzzle.title}"?`)) {
                puzzleBank.splice(index, 1);
                updateBankDisplay();
                updatePuzzleCount();
            }
        }
        
        function clearAllPuzzles() {
            if (puzzleBank.length === 0) {
                alert('No puzzles to clear.');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL saved puzzles? This cannot be undone.')) {
                puzzleBank = [];
                
                // Clear localStorage as well
                try {
                    localStorage.removeItem('unjumblePuzzles');
                    console.log('Cleared all puzzles from localStorage');
                } catch (e) {
                    console.error('Failed to clear localStorage:', e);
                }
                
                updateBankDisplay();
                updatePuzzleCount();
            }
        }
        
        function splitIntoSentences(text) {
            // Improved sentence splitting that handles common abbreviations
            const abbreviations = ['Dr.', 'Mr.', 'Mrs.', 'Ms.', 'Prof.', 'Sr.', 'Jr.', 'Ph.D', 'M.D', 'B.A', 'M.A', 'D.D.S', 'Ph.D.', 'U.S.', 'U.K.', 'E.U.', 'i.e.', 'e.g.', 'etc.', 'vs.'];
            
            // Replace abbreviations temporarily
            let modifiedText = text;
            const replacements = [];
            abbreviations.forEach((abbr, index) => {
                const placeholder = `__ABBR${index}__`;
                const regex = new RegExp(abbr.replace('.', '\\.'), 'g');
                if (modifiedText.includes(abbr)) {
                    replacements.push({ placeholder, abbr });
                    modifiedText = modifiedText.replace(regex, placeholder);
                }
            });
            
            // Split by sentence-ending punctuation followed by space and capital letter
            let sentences = modifiedText.match(/[^.!?]+[.!?]+/g) || [];
            
            // Restore abbreviations
            sentences = sentences.map(sentence => {
                let restored = sentence;
                replacements.forEach(({ placeholder, abbr }) => {
                    restored = restored.replace(new RegExp(placeholder, 'g'), abbr);
                });
                return restored.trim();
            });
            
            // Filter out empty sentences and clean up
            return sentences.filter(s => s.length > 0);
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function generateWorksheet() {
            const title = document.getElementById('title').value || 'UnJumble';
            const instructions = document.getElementById('instructions').value || 'Please read the following sentences and place them in their correct order.';
            const sourceText = document.getElementById('sourceText').value;
            const paragraph = document.getElementById('paragraph').value.trim();
            
            if (!paragraph) {
                alert('Please enter a paragraph to generate the worksheet.');
                return;
            }
            
            // Split into sentences
            const sentences = splitIntoSentences(paragraph);
            
            if (sentences.length < 2) {
                alert('Please enter a paragraph with at least 2 sentences.');
                return;
            }
            
            // Store the preliminary data
            editingSentences = [...sentences];
            
            // Show edit section instead of directly generating worksheet
            showEditSection(title, instructions, sourceText);
        }
        
        function showEditSection(title, instructions, sourceText) {
            // Hide preview notice if it was showing
            document.getElementById('previewNotice').classList.remove('active');
            
            // Hide worksheet if it was showing
            const worksheetDiv = document.getElementById('worksheet');
            worksheetDiv.classList.remove('active');
            
            // Build the sentence editor
            const editorHTML = editingSentences.map((sentence, index) => `
                <div class="sentence-editor-item" data-index="${index}">
                    <span class="sentence-editor-number">${index + 1}.</span>
                    <input type="text" class="sentence-editor-input" value="${sentence.replace(/"/g, '&quot;')}" onchange="updateSentence(${index}, this.value)">
                    <button class="remove-sentence-btn" onclick="removeSentence(${index})">Remove</button>
                </div>
            `).join('');
            
            document.getElementById('sentenceEditor').innerHTML = editorHTML;
            
            // Show edit section
            document.getElementById('editSection').classList.add('active');
            
            // Store metadata for later use
            document.getElementById('editSection').dataset.title = title;
            document.getElementById('editSection').dataset.instructions = instructions;
            document.getElementById('editSection').dataset.sourceText = sourceText;
            
            // Scroll to edit section
            document.getElementById('editSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updateSentence(index, value) {
            editingSentences[index] = value;
        }
        
        function removeSentence(index) {
            if (editingSentences.length <= 2) {
                alert('You must have at least 2 sentences for the worksheet.');
                return;
            }
            editingSentences.splice(index, 1);
            refreshEditor();
        }
        
        function addSentence() {
            editingSentences.push('');
            refreshEditor();
            // Focus on the new input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.sentence-editor-input');
                inputs[inputs.length - 1].focus();
            }, 100);
        }
        
        function refreshEditor() {
            const editorHTML = editingSentences.map((sentence, index) => `
                <div class="sentence-editor-item" data-index="${index}">
                    <span class="sentence-editor-number">${index + 1}.</span>
                    <input type="text" class="sentence-editor-input" value="${sentence.replace(/"/g, '&quot;')}" onchange="updateSentence(${index}, this.value)">
                    <button class="remove-sentence-btn" onclick="removeSentence(${index})">Remove</button>
                </div>
            `).join('');
            
            document.getElementById('sentenceEditor').innerHTML = editorHTML;
        }
        
        function cancelEdit() {
            document.getElementById('editSection').classList.remove('active');
            editingSentences = [];
        }
        
        function finalizeWorksheet() {
            // Get the metadata
            const editSection = document.getElementById('editSection');
            const title = editSection.dataset.title;
            const instructions = editSection.dataset.instructions;
            const sourceText = editSection.dataset.sourceText;
            
            // Filter out empty sentences
            const finalSentences = editingSentences.filter(s => s.trim().length > 0);
            
            if (finalSentences.length < 2) {
                alert('Please ensure you have at least 2 non-empty sentences.');
                return;
            }
            
            // Hide edit section
            document.getElementById('editSection').classList.remove('active');
            
            // Create array of numbers 1 through n
            const numbers = Array.from({length: finalSentences.length}, (_, i) => i + 1);
            
            // Shuffle the numbers to create random labeling
            const shuffledNumbers = shuffleArray(numbers);
            
            // Store worksheet data for different print versions
            currentWorksheetData = {
                title,
                instructions,
                sourceText,
                sentences: finalSentences,
                shuffledNumbers
            };
            
           // Generate worksheet HTML with new layout
            let worksheetHTML = `
                <div class="worksheet-header">
                    <div class="logo-container">
                        <img src="https://i.imgur.com/iIODsNl.png" alt="NYU Logo" class="worksheet-logo">
                    </div>
                    <div class="instructions-container">
                        <div class="worksheet-instructions">
                            ${sourceText ? `Please read the following sentences from ${sourceText}. ` : ''}${instructions}
                        </div>
                    </div>
                </div>
            `;
            
            // Add sentences in original order but with shuffled numbers
            finalSentences.forEach((sentence, index) => {
                worksheetHTML += `
                    <div class="sentence-item">
                        <div class="sentence-number">${shuffledNumbers[index]}</div>
                        <div class="sentence-text">${sentence}</div>
                    </div>
                `;
            });
            
            // Add submission sheet for students (will be hidden in modal preview)
            worksheetHTML += `
                <div class="submission-sheet hide-for-print" id="submissionSheet">
                    <div class="submission-title">UnJumble Submission Sheet</div>
                    
                    <div class="team-info">
                        <div class="team-line"><span>Team Name:</span> _________________________________</div>
                        <div class="team-line"><span>Members:</span> _________________________________</div>
                        <div class="team-line"><span></span> _________________________________</div>
                    </div>
                    
                    <div class="attempt-section">
                        <div class="attempt-header">Attempt 1</div>
                        <div class="attempt-grid">
                            ${Array(finalSentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                        </div>
                        <div class="feedback-line">
                            <span> You've got the first ______ sentence(s) in the right spots!
                        </div>
                    </div>
                    
                    <div class="attempt-section">
                        <div class="attempt-header">Attempt 2</div>
                        <div class="attempt-grid">
                            ${Array(finalSentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                        </div>
                        <div class="feedback-line">
                            <span> You've got the first ______ sentence(s) in the right spots!
                        </div>
                    </div>
                    
                    <div class="attempt-section">
                        <div class="attempt-header">Attempt 3</div>
                        <div class="attempt-grid">
                            ${Array(finalSentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                        </div>
                        <div class="feedback-line">
                             <span> You've got the first ______ sentence(s) in the right spots!
                        </div>
                    </div>
                </div>
            `;
            
            // Add answer section (visible in modal preview)
            worksheetHTML += `
                <div class="answer-section" id="answerSection">
                    <div class="answer-label">INSTRUCTOR ANSWER KEY:</div>
                    <div class="answer-text">${shuffledNumbers.join(', ')}</div>
                </div>
            `;
            
            // Display worksheet in modal
            document.getElementById('worksheetPreviewContent').innerHTML = worksheetHTML;
            document.getElementById('worksheetPreviewModal').classList.add('active');
            
            // Clear editing sentences
            editingSentences = [];
        }

        function closeWorksheetPreview() {
            const modal = document.getElementById('worksheetPreviewModal');
            modal.classList.remove('active');
        }
        
        function printStudentVersion() {
    if (!currentWorksheetData) {
        alert('Please generate a worksheet first.');
        return;
    }
    
    // Create a temporary print window with student version
    const printWindow = window.open('', '_blank');
    
    // Create array of sentence objects with their assigned numbers
    const sentencesWithNumbers = currentWorksheetData.sentences.map((sentence, index) => ({
        sentence: sentence,
        number: currentWorksheetData.shuffledNumbers[index]
    }));
    
    // Sort by the assigned numbers to show them in numerical order (1, 2, 3, etc.)
    // This way students get the cut-out slips in order by number, not by correct sequence
    sentencesWithNumbers.sort((a, b) => a.number - b.number);
    
    // Generate student worksheet HTML with sentences ordered by their assigned numbers
    let studentHTML = `
        <div class="worksheet-header">
            <div class="logo-container">
                <img src="https://i.imgur.com/iIODsNl.png" alt="NYU Logo" class="worksheet-logo">
            </div>
            <div class="instructions-container">
                <div class="worksheet-instructions">
                    ${currentWorksheetData.sourceText ? `Please read the following sentences from ${currentWorksheetData.sourceText}. ` : ''}${currentWorksheetData.instructions}
                </div>
            </div>
        </div>
    `;
    
    // Add sentences ordered by their numbers (so slip #1 comes first, then #2, etc.)
    sentencesWithNumbers.forEach((item) => {
        studentHTML += `
            <div class="sentence-item-cut">
                <div class="sentence-number-cut">${item.number}</div>
                <div class="sentence-text-cut">${item.sentence}</div>
            </div>
        `;
    });
    
    // Add submission sheet
    studentHTML += `
        <div class="submission-sheet">
            <div class="submission-title">UnJumble Submission Sheet</div>
            
            <div class="team-info">
                <div class="team-line"><span>Team Name:</span> _________________________________</div>
                <div class="team-line"><span>Members:</span> _________________________________</div>
                <div class="team-line"><span></span> _________________________________</div>
            </div>
            
            <div class="attempt-section">
                <div class="attempt-header">Attempt 1</div>
                <div class="attempt-grid">
                    ${Array(currentWorksheetData.sentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                </div>
                <div class="feedback-line">
                    <span>You've got the first ______ sentence(s) in the right spots!</span>
                </div>
            </div>
            
            <div class="attempt-section">
                <div class="attempt-header">Attempt 2</div>
                <div class="attempt-grid">
                    ${Array(currentWorksheetData.sentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                </div>
                <div class="feedback-line">
                    <span>You've got the first ______ sentence(s) in the right spots!</span>
                </div>
            </div>
            
            <div class="attempt-section">
                <div class="attempt-header">Attempt 3</div>
                <div class="attempt-grid">
                    ${Array(currentWorksheetData.sentences.length).fill('').map(() => '<div class="number-box"></div>').join('')}
                </div>
                <div class="feedback-line">
                    <span>You've got the first ______ sentence(s) in the right spots!</span>
                </div>
            </div>
        </div>
    `;
    
    printWindow.document.write(`
        <html>
        <head>
            <title>UnJumble Worksheet - Student Version</title>
            <style>${getWorksheetPrintStyles()}</style>
        </head>
        <body>${studentHTML}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}

        function printInstructorVersion() {
            if (!currentWorksheetData) {
                alert('Please generate a worksheet first.');
                return;
            }
            
            // Create a temporary print window with instructor version
            const printWindow = window.open('', '_blank');
            
            // Generate instructor worksheet HTML with same shuffled numbers as students see
            let instructorHTML = `
                <div class="worksheet-header">
                    <div class="logo-container">
                        <img src="https://i.imgur.com/iIODsNl.png" alt="NYU Logo" class="worksheet-logo">
                    </div>
                    <div class="instructions-container">
                        <div class="worksheet-instructions">
                            ${currentWorksheetData.sourceText ? `Please read the following sentences from ${currentWorksheetData.sourceText}. ` : ''}${currentWorksheetData.instructions}
                        </div>
                    </div>
                </div>
            `;
            
            // Add sentences in original order but with the same shuffled numbers students see
            currentWorksheetData.sentences.forEach((sentence, index) => {
                instructorHTML += `
                    <div class="sentence-item">
                        <div class="sentence-number">${currentWorksheetData.shuffledNumbers[index]}</div>
                        <div class="sentence-text">${sentence}</div>
                    </div>
                `;
            });
            
            // Add answer section showing the correct sequence
            instructorHTML += `
                <div class="answer-section">
                    <div class="answer-label">INSTRUCTOR ANSWER KEY:</div>
                    <div class="answer-text">Correct sequence: ${currentWorksheetData.shuffledNumbers.join(', ')}</div>
                </div>
            `;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>UnJumble Worksheet - Instructor Copy</title>
                    <style>${getWorksheetPrintStyles()}</style>
                </head>
                <body>${instructorHTML}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        }

        function getWorksheetPrintStyles() {
    return `
        body { font-family: 'Times New Roman', serif; padding: 20px 30px; font-size: 12pt; }
        .worksheet-header { 
            margin-bottom: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 10px; 
        }
       .logo-container { 
            width: 100%; 
            display: flex; 
            justify-content: flex-end;
            margin-bottom: 5px;
        }
        .worksheet-logo { 
            height: 35px; 
            width: auto;
            display: block;
        }
        .instructions-container { 
            width: 100%; 
            border: 1px solid #000; 
            padding: 10px; 
            background: #f9f9f9; 
        }
        .worksheet-instructions { 
            font-size: 10pt; 
            line-height: 1.3; 
            text-align: left; 
            color: #000; 
            margin: 0;
        }
        .sentence-item { display: flex; margin: 8px 0; border: 1px solid #000; background: white; align-items: center; }
        .sentence-number { font-weight: bold; font-size: 1.4em; padding: 15px 20px; min-width: 60px; color: #000; text-align: center; border-right: 1px solid #000; }
        .sentence-text { flex: 1; font-size: 1em; line-height: 1.4; color: #000; padding: 15px 20px; }
        .sentence-item-cut {
            display: flex;
            margin: 8px 0;
            border-top: 2px dashed #999;
            border-bottom: 2px dashed #999;
            border-left: 2px dashed #999;
            border-right: 2px dashed #999;
            background: white;
            align-items: center;
            position: relative;
        }
        .sentence-item-cut::before {
            content: "✂";
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            background: white;
            padding: 2px;
            font-size: 12px;
            color: #666;
        }
        .sentence-item-cut::after {
            content: "✂";
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
            background: white;
            padding: 2px;
            font-size: 12px;
            color: #666;
        }
        .sentence-number-cut {
            font-weight: bold;
            font-size: 1.4em;
            padding: 15px 20px;
            min-width: 60px;
            color: #000;
            text-align: center;
            border-right: 1px solid #000;
        }
        .sentence-text-cut {
            flex: 1;
            font-size: 1em;
            line-height: 1.4;
            color: #000;
            padding: 15px 20px;
        }
        .submission-sheet { margin-top: 40px; padding: 30px; border: 2px solid #000; page-break-before: always; }
        .submission-title { font-size: 1.4em; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .team-info { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #000; }
        .team-line { margin: 10px 0; font-size: 1.1em; }
        .team-line span { display: inline-block; width: 150px; }
        .attempt-section { margin: 25px 0; padding: 20px; border: 1px solid #000; }
        .attempt-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        .attempt-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .number-box { width: 40px; height: 40px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; }
        .feedback-line { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #666; font-size: 1em; }
        .feedback-line span { display: inline-block; width: auto; }
        .answer-section { margin-top: 30px; padding: 20px; border: 2px solid #57068c; background: #f9f7fc; }
        .answer-label { font-weight: bold; font-size: 1.2em; display: block; color: #57068c; margin-bottom: 10px; }
        .answer-text { font-size: 1.1em; color: #000; display: block; }
    `;
}
        
        function resetForm() {
            document.getElementById('title').value = 'UnJumble';
            document.getElementById('instructions').value = 'Please read the following sentences and place them in their correct order. Each team only gets three guesses. Teams who finish in 10 minutes get a 24-hour extension.';
            document.getElementById('sourceText').value = '';
            document.getElementById('paragraph').value = '';
            document.getElementById('worksheet').classList.remove('active');
            document.getElementById('worksheet').innerHTML = '';
            document.getElementById('previewNotice').classList.remove('active');
            currentWorksheetData = null;
        }
    </script>
</body>
</html>
